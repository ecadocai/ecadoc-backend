name: Deploy Backend to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'modules/**'
      - 'requirements.txt'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner != 'dependabot[bot]' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            set -euo pipefail
            if [ -z "${DEPLOY_DIR:-}" ]; then echo "DEPLOY_DIR not set"; exit 1; fi
            echo "Deploying to $DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            # Ensure repo exists and is clean
            git fetch origin main
            git reset --hard origin/main
            # Python env
            if [ ! -d .venv ]; then python3 -m venv .venv; fi
            . .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            # Restart app (customizable)
            if [ -n "${SERVICE_RESTART_CMD:-}" ]; then
              echo "Restarting service via SERVICE_RESTART_CMD"
              eval "$SERVICE_RESTART_CMD"
            elif command -v systemctl >/dev/null 2>&1; then
              echo "Restarting via systemctl ecadoc-backend.service"
              sudo systemctl restart ecadoc-backend.service || true
            elif command -v supervisorctl >/dev/null 2>&1; then
              echo "Restarting via supervisorctl ecadoc-backend"
              supervisorctl restart ecadoc-backend || true
            elif command -v pm2 >/dev/null 2>&1; then
              echo "Restarting via pm2 'ecadoc-backend'"
              pm2 restart ecadoc-backend || true
            else
              echo "No known service manager; please set SERVICE_RESTART_CMD secret"
              exit 1
            fi
            echo "Deployed $(git rev-parse --short HEAD)"
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
          SERVICE_RESTART_CMD: ${{ secrets.SERVICE_RESTART_CMD }}

